<!doctype html>
<html lang="en">
  <head>
    <title>Spotify and Youtube, on the same page.</title>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="icon"
      type="image/png"
      href="https://img.icons8.com/bubbles/50/000000/spotify.png">
    <style type="text/css">
      #login, #loggedin, #loggedin_debugging, #youtube-player {
        display: none;
      }
      .text-overflow {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 500px;
      }
      .input-group {
        width: 100%;
      }
    </style>
    <!-- More readable on mobile https://stackoverflow.com/a/30459783 : -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
  </head>

  <body>
    <div class="container">
      <div class="card text-white bg-dark mb-3" style="width: 100%;">
        <div class="card-body">
          <h3 class="card-title">Spotify and Youtube, on the same page.</h5>
          <!-- <p class="card-text">Find something clever to say</p> -->
        </div>
      </div>
      <div id="login">
        <button class="btn btn-outline-success" onclick="ytfy.spotify.api.log_in();">Log in with your Spotify account</button>
      </div>
      <div id="loggedin_debugging">
        <button class="btn btn-outline-success" onclick="ytfy.spotify.pause();">Pause spotify</button>
        <button class="btn btn-outline-success" onclick="ytfy.spotify.play();">Play spotify</button>
      </div>
      <div id="loggedin">
        <div class="card border-success mb-3" title="Click to read more">
          <div class="card-body text-success p-2">
            <span id="ellipsis-ex" class="card-text d-inline-block text-truncate small" style="max-width: 100%;">
              <div id="spotify-status"></div>
            </span>
          </div>
        </div>
        <form id="track_search_form" class="mb-3">
          <input type="text" class="form-control" placeholder="Type track's title and press enter"
          aria-label="Track's title" aria-describedby="basic-addon2" id="search_input">
        </form>
        <table class="table table-striped small">
          <tbody id="spotify-tracks"></tbody>
        </table>
        <div id="status"></div>
      </div>
      <div id="youtube-player">
        <div align="right">
          <button type="button" class="close text-danger" aria-label="Close"
                  onclick="ytfy.yt_player.stopVideo();ytfy.yt_player.resumeSpotifyIfNeeded();">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div id="youtube-actual-player"></div>
      </div>
    </div>

    <script id="spotify-status-template" type="text/x-handlebars-template">
      <div>Spotify playback on <b>{{spotify_active_device}}</b>. If your device is
      not showing up, wake it up by playing some stuff directly on it. Please note that,
      in the search results, <b>Play</b> directly plays the song while <b>Queue & Play</b> adds
      it to the queue and jumps to it (assuming queue was empty before). Finally, when playing a
      Youtube video, Spotify gets paused. When video ends or when you close it, Spotify playback
      will resume if it was playing before (assuming the device did not go offline).
      <small><a href="https://icons8.com/icon/116712/spotify">Spotify icon by Icons8</a></small>.
    </div>
    </script>

    <script id="play_or_queue-button-common-template" type="text/x-handlebars-template">
      <button class="btn btn-sm {{button_style}} {{platform_and_action}}" type="submit" value={{uri}}>{{label}}</button>
    </script>

    <script type="text/javascript" src="//cdn.jsdelivr.net/npm/async@3.2.0/dist/async.min.js"></script>
    <!--
      dependencies: youtify.js to be loaded before google client so
      that googleApiClientReady is already declared
    -->
    <script type="text/javascript" src="spotify_api.js"></script>
    <script type="text/javascript" src="youtify.js"></script>
    <script src="//apis.google.com/js/client.js?onload=googleApiClientReady"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="//code.jquery.com/jquery-3.4.1.min.js"></script>

    <script>
      (function() {
        var searchResultsPlaceholder = document.getElementById('spotify-tracks');

        var playButtonTemplate = Handlebars.compile(
          document.getElementById('play_or_queue-button-common-template').innerHTML);

        var spotifyStatusTemplate = Handlebars.compile((document.getElementById('spotify-status-template').innerHTML));
        var spotifyStatusPlaceholder = document.getElementById('spotify-status');

        var timer;
        var collapsableStatusText;
        function updateSpotifyStatus()
        {
          ytfy.spotify.spotify_active_device()
          .then(function(data) {
            spotifyStatusPlaceholder.innerHTML = spotifyStatusTemplate({
              spotify_active_device:data
            });
            // re-compute each time
            collapsableStatusText = document.getElementById("ellipsis-ex");

          }).catch(function(err) {
            console.log('Could not refresh device name', err);
            cancelActivityRefresh();
          });
        }
        function startActivityRefresh() {
          const refresh_rate_seconds = 30;
          timer = setInterval(updateSpotifyStatus, refresh_rate_seconds*1000)
        }
        function cancelActivityRefresh() {
          clearInterval(timer);
        }
        function toggleSpotifyStatus() {
          collapsableStatusText.classList.toggle("text-truncate");
        };
        spotifyStatusPlaceholder.addEventListener("click", function(e) {
          toggleSpotifyStatus();
          updateSpotifyStatus();
        });


        is_logged_in.catch(alert).then(function(is_logged_in) {
          if (is_logged_in) {

            $('#login').hide();
            $('#loggedin').show();

            startActivityRefresh(); // 1st to create timer
            updateSpotifyStatus(); // second, to be sure timer exist when it has to be cancelled

          } else {
              // render initial screen
              $('#login').show();
              $('#loggedin').hide();
          }

          document.getElementById('track_search_form').addEventListener('submit', function(event){
            // to avoid the page refresh, source:
            // https://stackoverflow.com/questions/33211672/#comment58405263_33212911
            event.preventDefault();

            var dadata = $('#search_input').val();

            ytfy.common.search(dadata)
            .then(function(search_results)
            {
              /** Update @param result_body html table with @param result_data, map of array of items. */
              function setResultTable(results_body, results_data)
              {
                results_body.innerHTML = '';  // hard reset
                for (var platform in results_data)
                {
                  results_data[platform].forEach(function(element){
                    var tr = results_body.insertRow();

                    // Title
                    var cell = tr.insertCell();
                    cell.innerHTML = element.name;
                    cell.style.verticalAlign = "middle";
                    const actions = {spotify:'play_spotify_button', youtube:'play_youtube_button'};
                    const buttons = {spotify:'btn-outline-success', youtube:'btn-outline-danger'};

                    // Play button
                    var btn_cell = tr.insertCell();
                    btn_cell.innerHTML = playButtonTemplate({
                      uri:element.uri,
                      platform_and_action:actions[platform],
                      label: 'Play',
                      button_style: buttons[platform],
                    });

                    btn_cell.style.verticalAlign = "middle";

                    // Queue button
                    btn_cell = tr.insertCell();
                    if (platform == 'spotify')
                    {
                      btn_cell.innerHTML = playButtonTemplate({
                        uri:element.uri,
                        platform_and_action:'queue_spotify_button',
                        label: 'Queue & Play',
                        button_style: buttons[platform],
                      });

                      btn_cell.style.verticalAlign = "middle";
                    }
                    results_body.appendChild(tr);
                  });
                }
              }

              setResultTable(searchResultsPlaceholder, search_results);
            })
            .catch(alert);
          });

          // https://davidwalsh.name/event-delegate
          document.getElementById("spotify-tracks").addEventListener("click", function(e) {
            // e.target is the clicked element!
            if(e.target)
            {
              // Check which button was clicked
              var btnClass = null;
              ["play_spotify_button", "queue_spotify_button", "play_youtube_button"].forEach(value => {
                if (e.target.classList.contains(value)) {
                  btnClass = value;
                }
              });

              if (btnClass)
              {
                if (["play_spotify_button", "queue_spotify_button"].includes(btnClass)) {
                  var action_map = {
                    "play_spotify_button":ytfy.spotify.play,
                    "queue_spotify_button":ytfy.spotify.queue,
                  };
                  action_map[btnClass](e.target.value);
                  ytfy.yt_player.stopVideo();
                } else if (btnClass == "play_youtube_button") {
                  ytfy.yt_player.playVideo(e.target.value);
                  ytfy.spotify.pause()
                  .then(function(data) {
                    if (data.error)
                    {
                      console.log(data.error);
                    };
                    if (data.was_playing)
                    {
                      ytfy.yt_player.playSpotifyOnVideoEnd = true;
                    }
                  });
                }
              }
            }
          });
        });
      })();
    </script>
  </body>
</html>

